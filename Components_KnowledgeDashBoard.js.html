

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Components/KnowledgeDashBoard.js | Wisdoom</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 30px; height: 30px">
        
            <a href="https://nhannht.github.io/wisdoom/" rel="noopener noreferrer" target="_blank">
                <img src="https://raw.githubusercontent.com/nhannht/wisdoom/master/src/icons/wisdoomIcon.svg" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Wisdoom</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="DraggableButton.html">DraggableButton</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DraggableButton_sub"></div></li><li><a href="GoogleTabs.html">GoogleTabs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="GoogleTabs_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="GoogleTabs.html#~json">json</a></li><li><a href="GoogleTabs.html#~listPods">listPods</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="GoogleTabs.html#~findPodWithTitle">findPodWithTitle</a></li><li><a href="GoogleTabs.html#~truncate">truncate</a></li></ul></div></li><li><a href="ImageActions.html">ImageActions</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ImageActions_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="ImageActions.html#~subpodId">subpodId</a></li><li><a href="ImageActions.html#~subpodTooltipId">subpodTooltipId</a></li></ul></div></li><li><a href="ImageComponent.html">ImageComponent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ImageComponent_sub"></div></li><li><a href="KnowledgeDashBoard.html">KnowledgeDashBoard</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="KnowledgeDashBoard_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="KnowledgeDashBoard.html#~sidebarHeightWithoutHeader">sidebarHeightWithoutHeader</a></li><li><a href="KnowledgeDashBoard.html#~windowHeight">windowHeight</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="KnowledgeDashBoard.html#~onDragStart">onDragStart</a></li><li><a href="KnowledgeDashBoard.html#~onDragStop">onDragStop</a></li><li><a href="KnowledgeDashBoard.html#~renderAssumptions">renderAssumptions</a></li><li><a href="KnowledgeDashBoard.html#~renderPods">renderPods</a></li><li><a href="KnowledgeDashBoard.html#~sendQueryToBackGround">sendQueryToBackGround</a></li><li><a href="KnowledgeDashBoard.html#~toggleSideBar">toggleSideBar</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#api">api</a></li><li><a href="global.html#downloadUrl">downloadUrl</a></li><li><a href="global.html#freeInputListener">freeInputListener</a></li><li><a href="global.html#getWolframFullResult">getWolframFullResult</a></li><li><a href="global.html#KnowledgeDashBoardPlaceHolder">KnowledgeDashBoardPlaceHolder</a></li><li><a href="global.html#oldFreeStyleQuery">oldFreeStyleQuery</a></li><li><a href="global.html#oldSearch">oldSearch</a></li><li><a href="global.html#setDefault">setDefault</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global chrome */
// BOOKMARK import here
import Button from '@jetbrains/ring-ui/dist/button/button';
import {Menu, MenuItem, Sidebar, SubMenu, useProSidebar} from "react-pro-sidebar";
import Island from "@jetbrains/ring-ui/dist/island/island";
import Header from "@jetbrains/ring-ui/dist/header/header";
import {H3, H4} from "@jetbrains/ring-ui/dist/heading/heading";
import {useEffect, useState} from "react";
import Img from 'react-image';
import Loader from '@jetbrains/ring-ui/dist/loader/loader';
import Tray from "@jetbrains/ring-ui/dist/header/tray";
import TrayIcon from '@jetbrains/ring-ui/dist/header/tray-icon';
import settingIcon from '@jetbrains/icons/settings';
import collapseIcon from '@jetbrains/icons/collapse';
import starIcon from '@jetbrains/icons/star-empty';
import likeIcon from '@jetbrains/icons/vote-empty';
import Text from '@jetbrains/ring-ui/dist/text/text';
import '@jetbrains/icons/file-js'
import Panel from "@jetbrains/ring-ui/dist/panel/panel";
import ImageActions from "./ImageActions";
import DraggableButton from "./KnowledgeDashBoard/DraggableButton";
import 'rc-dropdown/assets/index.css';
import Link from "@jetbrains/ring-ui/dist/link/link";
import {Col, Grid, Row} from '@jetbrains/ring-ui/dist/grid/grid';
import WolframIcon from '@jetbrains/icons/asterisk';
import ButtonGroup from '@jetbrains/ring-ui/dist/button-group/button-group';
import ReactTooltip from "react-tooltip";
import LoaderInline from "@jetbrains/ring-ui/dist/loader-inline/loader-inline";
import * as PropTypes from "prop-types";
import {SettingsView} from "./SettingsView";
import {WolframAlphaSearchArea} from "./WolframAlphaSearchArea";
import {Readability} from "@mozilla/readability"
import {uniq, filter} from "lodash";
import Badge from "@jetbrains/ring-ui/dist/badge/badge";

SettingsView.propTypes = {
    onKeyDown: PropTypes.func,
    onClick: PropTypes.func
};


/**
 * @desc This is Knowledge Dashboard
 * @class KnowledgeDashBoard
 * @returns {JSX.Element}
 * @todo How to design a program
 */
export default function KnowledgeDashBoard() {


// BOOKMARK state of this file
    /**
     * @desc state of this file
     */
    const [state, setState] = useState({
        currentQuery: "",
        currentAssumption: "",
        queryResult: [],
        dashBoardHidden: true,
        buttonPosition: {x: 0, y: 0},
        currentView: 'WolframAlpha',
        loadingDraggableButton: false,
        loadingResult: false,
    });
    const [isUsingDemoApi, setIsUsingDemoApi] = useState(undefined);
    chrome.storage.sync.get("wolframApi", (result) => {
        if (result.wolframApi === 'DEMO') {
            setIsUsingDemoApi(true);
        } else {
            setIsUsingDemoApi(false);
        }
    })
    const [currentPageReadability, setCurrentPageReadability] = useState(undefined);
    const [entities, setEntities] = useState(undefined);
    window.onload = () => {
        console.log("page is fully loaded")
        const clonedDocument = document.cloneNode(true)
        const pageReadability = new Readability(clonedDocument).parse()
        if (currentPageReadability !== pageReadability) {
            setCurrentPageReadability(pageReadability)
        }
    }

    useEffect(() => {
        chrome.runtime.sendMessage({textRazorEntitiesQuery: currentPageReadability?.textContent}, (result) => {
            const entities = result.response.entities
            const highConfidenceAndRelevanceEntities = filter(entities, (entity) => entity.confidenceScore > 5.0 &amp;&amp; entity.relevanceScore > 0.9)
            const uniqueEntitiesId = uniq(highConfidenceAndRelevanceEntities.map((entity) => entity.entityId))
            setEntities(uniqueEntitiesId)
        })
    }, [currentPageReadability])

    const renderEntities = () => {
        if (entities) {
            return entities.map(entity => {
                return (&lt;Badge valid
                               style={{cursor: 'pointer'}}
                               onClick={() => {
                                   sendQueryToBackGround(entity, undefined, undefined, undefined)
                               }}
                >{entity}&lt;/Badge>)
            })
        }
    }
    /**
     * @desc state of React-Pro-Sidebar
     */
    const {collapseSidebar, toggleSidebar, collapsed} = useProSidebar();
    // Fetch wolfram api in background and set to this component stage
    // Set wolfram api in background when this component state change


    /**
     * @function
     * @desc Toggle sidebar
     */
    function toggleSideBar() {
        if (collapsed) {
            toggleSidebar(true);
            collapseSidebar(false);
            setState({...state, dashBoardHidden: false});
        } else {
            collapseSidebar(true);
            toggleSidebar(false);
            setState({...state, dashBoardHidden: true});
        }
    }


    /**
     * @function
     * @param query
     * @param assumption
     * @param reinterpret
     * @param podstate
     */
    function sendQueryToBackGround(query,
                                   assumption,
                                   reinterpret,
                                   podstate = ""
    ) {
        // console.log("currentAssumption is",state.currentAssumption)
        setState(prevState => ({...prevState, currentQuery: query}));
        setState(prevState => ({...prevState, loadingResult: true}));
        if (assumption !== undefined) {
            setState(prevState => ({...prevState, currentAssumption: assumption}));
        }
        // If query is change, assumption simply get reset, at least in our case
        chrome.runtime.sendMessage({
            freeStyleQuery: query,
            assumption: assumption,
            reinterpret: reinterpret,
            podstate: podstate
        }, (response) => {
            setState(prevState => ({...prevState, queryResult: response.queryresult}));
            setState(prevState => ({...prevState, loadingResult: false}));
        });
    }

    /**
     * @function
     * @param e
     */
    function onDragStart(e) {
        setState({...state, buttonPosition: {x: e.screenX, y: e.screenY}});
    }

    /**
     * @function
     * @param e
     */
    function onDragStop(e) {
        const dragX = Math.abs(e.screenX - state.buttonPosition.x);
        const dragY = Math.abs(e.screenY - state.buttonPosition.y);
        // console.log(dragX,dragY)
        if (dragX > 5 || dragY > 5) {
            e.stopPropagation();
        } else {
            toggleSideBar();
        }

    }

    /**
     * Set wolfram key
     * @function
     * @param key
     */


    // DONE render podstate
    /**
     * @function
     * @returns {*}
     */
    function renderPods() {
        const queryResult = state.queryResult;
        if (queryResult.success === false) return;
        const query = queryResult.inputstring;
        const pods = queryResult.pods;
        let renderPods = null;
        if (queryResult.pods === undefined) return;
        renderPods = pods.map((pod, index) => {
            let renderStates;
            // DONE render states
            if (pod.states) {
                const statesArray = [];
                for (let i = 0; i &lt; pod.states.length; i++) {
                    if (pod.states[i].states) {
                        for (let j = 0; j &lt; pod.states[i].states.length; j++) {
                            statesArray.push(pod.states[i].states[j]);
                        }
                    } else {
                        statesArray.push(pod.states[i]);
                    }
                }
                renderStates = statesArray.map((state_, index) => {
                    const podStateInput = state_.input;
                    const podStateName = state_.name;
                    return (
                        &lt;span>
                            {index > 0 &amp;&amp; ", "}
                            &lt;Link
                                onClick={() => {
                                    sendQueryToBackGround(query,
                                        state.currentAssumption,
                                        true, podStateInput)
                                }
                                }
                            >{podStateName}&lt;/Link>&lt;/span>
                    )
                })
            }
            /**
             * @function
             */
            const subpodRender = pod.subpods.map((subpod, index) => {
                const subpodTitle = subpod.title;
                const subpodImage = subpod.img.src;
                const height = subpod.img.height;
                const width = subpod.img.width;
                let renderSubpodStates;

                if (subpod.states) {
                    const subpodStatesArray = [];
                    for (let i = 0; i &lt; subpod.states.length; i++) {
                        if (subpod.states[i].states) {
                            for (let j = 0; j &lt; subpod.states[i].states.length; j++) {
                                subpodStatesArray.push(subpod.states[i].states[j]);
                            }
                        } else {
                            subpodStatesArray.push(subpod.states[i]);
                        }
                    }

                    renderSubpodStates = subpodStatesArray.map((state_, index) => {
                        const subpodStateInput = state_.input;
                        const subpodStateName = state_.name;
                        return (
                            &lt;span>
                                {index > 0 &amp;&amp; ", "}
                                &lt;Link
                                    onClick={() => {
                                        sendQueryToBackGround(query,
                                            state.currentAssumption,
                                            true, subpodStateInput)
                                    }
                                    }
                                >{subpodStateName}&lt;/Link>&lt;/span>
                        )
                    })
                }
                return (

                    &lt;Grid>

                        &lt;Row>
                            &lt;Col>
                                &lt;Row>&lt;H4 key={index}>
                                    {subpodTitle}
                                &lt;/H4>&lt;/Row>
                                {subpod.states &amp;&amp; &lt;Text>Other states: {renderSubpodStates}&lt;/Text>}
                                {/*TODO make those image ease in out*/}
                                &lt;Row>&lt;Img src={subpodImage}
                                          height={height}
                                          width={width}
                                          key={subpodImage}
                                          loader={&lt;Loader/>}
                                          unloader={&lt;Text>Image not found&lt;/Text>}
                                          style={{animation: "slideIn 1s forwards"}}
                                />&lt;/Row>
                            &lt;/Col>
                            &lt;Col xs={12}>
                                &lt;Row end={"xs"}>
                                    &lt;Col xs={6}>&lt;ImageActions subpod={subpod}/>&lt;/Col>
                                &lt;/Row>
                            &lt;/Col>
                        &lt;/Row>&lt;/Grid>
                )
            })
            return (
                &lt;Panel
                    key={index}>
                    &lt;H3>
                        &lt;Text>{pod.title}&lt;/Text>
                    &lt;/H3>
                    {pod.states &amp;&amp; &lt;Text>Other states: {renderStates}&lt;/Text>}
                    {subpodRender}
                &lt;/Panel>
            )
        })
        return renderPods;


    }

    /*

     */
    /**
     * @function
     */
    function renderAssumptions() {
        const queryResult = state.queryResult;
        // console.log("query result", queryResult)
        const query = queryResult.inputstring;
        if (queryResult.success === false) return
        let assumptionRender = null;


        const simpleTypes = ["Clash", "MultiClash", "SubCategory", "SubCategory", "Attribute"
            , "Unit", "AngleUnit", "Function", "TimeAMOrPM", "DateOrder",
            "MortalityYearDOB", "ListOrTimes", "ListOrNumber", "CoordinateSystem",
            "I", "NumberBase", "MixedFraction", "TideStation"]
        if (queryResult.assumptions) {
            if (Array.isArray(queryResult.assumptions)) {
                const assumptionArray = queryResult.assumptions;
                assumptionRender = assumptionArray.map((assumptions, index) => {
                    const type = assumptions.type;
                    // console.log(assumptions)
                    if (simpleTypes.includes(type)) {
                        const descriptions = assumptions.values.map((assumption) => assumption.desc);
                        const inputs = assumptions.values.map((assumption) => assumption.input);
                        const selectedData = descriptions.map((description, index) => ({
                                label: description,
                                input: inputs[index],
                                key: index,
                            })
                        )
                        const menuItemRender = selectedData.splice(1).map((data) => {
                            return (
                                &lt;MenuItem key={data.key}
                                          onClick={() => {
                                              sendQueryToBackGround(query, data.input)
                                          }}>
                                    {data.label}
                                &lt;/MenuItem>
                            )
                        })
                        return (
                            &lt;p>
                                Assuming &lt;Link>{selectedData[0].label}&lt;/Link>, other assumptions
                                &lt;Menu
                                    closeOnClick={true}
                                >
                                    &lt;SubMenu label={type}>
                                        {menuItemRender}
                                    &lt;/SubMenu>

                                &lt;/Menu>
                            &lt;/p>
                        )


                    }
                })
            } else if (queryResult.assumptions.values !== undefined) {
                const assumptions = queryResult.assumptions.values;
                const assumptionsType = queryResult.assumptions.type;
                const descriptions = assumptions.map((assumption) => assumption.desc);
                const inputs = assumptions.map((assumption) => assumption.input);
                const selectedData = descriptions.map((description, index) => ({
                    label: description,
                    input: inputs[index],
                    key: index,
                }))
                const menuItemRender = selectedData.splice(1).map((data) => {
                    return (
                        &lt;MenuItem

                            key={data.key}
                            onClick={() => {
                                sendQueryToBackGround(query, data.input)
                            }}>
                            {data.label}
                        &lt;/MenuItem>
                    )
                })
                assumptionRender = (
                    &lt;p>
                        Assuming &lt;Link>{selectedData[0].label}&lt;/Link>, other assumptions
                        &lt;Menu
                            closeOnClick={true}
                        >

                            {menuItemRender}

                        &lt;/Menu>&lt;/p>)


            }
        }
        return (
            &lt;Panel>
                {assumptionRender}
            &lt;/Panel>
        )


    }


    /**
     *
     * @type {number}
     */
    const windowHeight = window.innerHeight;
    /**
     *
     * @type {number}
     */
    const sidebarHeightWithoutHeader = windowHeight - 64;

    return (
        &lt;div>
            &lt;DraggableButton
                title={"Wisdoom!!!!!"}
                onStart={onDragStart} onStop={onDragStop} state={state}/>
            {/*TODO make the header in sidebar sticky*/}
            &lt;Sidebar
                defaultCollapsed={true}
                collapsedWidth={0}
                width={"50%"}
                // white
                backgroundColor={"#ffffff"}
                style={{
                    position: "fixed",
                    bottom: 0,
                    right: 0,
                    height: sidebarHeightWithoutHeader,
                    // set right border visible
                    border: "1px solid #e0e0e0",
                }}>
                &lt;Island
                    style={{
                        position: "sticky",
                        border: "none", boxShadow: "none",
                    }}
                >
                    {/*How to make this header sticky*/}
                    &lt;Header
                        style={{
                            position: "fixed", top: 0,
                            width: "50%",
                            display: "flex",
                            zIndex: 1000000
                        }}
                    >
                        &lt;ButtonGroup
                            split={true}
                        >
                            &lt;Button
                                id={"closeButton"}
                                data-tip={"Collapse"}
                                data-for={"collapse-tooltip"}
                                style={{
                                    paddingTop: "4px",
                                    paddingLeft: "8px",
                                    paddingRight: "8px",
                                    height: "61px",
                                }}
                                icon={collapseIcon} onClick={() => {
                                toggleSideBar()
                            }}>&lt;/Button>
                            &lt;ReactTooltip id={"collapse-tooltip"} place={"bottom"} effect={"solid"}>&lt;/ReactTooltip>
                            {/*&lt;div style={{display: state.loadingResult ? "block" : "none",}}>*/}
                            {/*    &lt;div className="ring-loader-inline"/>*/}
                            {/*&lt;/div>*/}
                        &lt;/ButtonGroup>
                        &lt;Text>&lt;LoaderInline
                            style={{
                                display: state.loadingResult ? "inline-block" : "none",
                                top: "4px"

                            }}
                        />&lt;/Text>
                        &lt;Tray>


                            &lt;TrayIcon
                                icon={WolframIcon}
                                data-tip={"Wolfram Alpha"}
                                data-for={"wolfram-alpha-tooltip"}
                                onClick={() => {
                                    setState({...state, currentView: "WolframAlpha"})
                                }
                                }/>
                            &lt;ReactTooltip id={"wolfram-alpha-tooltip"} place={"bottom"} effect={"solid"}>&lt;/ReactTooltip>

                            &lt;TrayIcon
                                icon={settingIcon}
                                data-tip={"Settings"}
                                data-for={"settings-tooltip"}
                                onClick={(e) => {
                                    setState({...state, currentView: "Settings"});
                                }}
                                id={"settingButton"}
                            >
                            &lt;/TrayIcon>
                            &lt;ReactTooltip id={"settings-tooltip"} place={"bottom"} effect={"solid"}>&lt;/ReactTooltip>
                            &lt;TrayIcon
                                data-tip={"Source code"}
                                data-for={"source-code-tooltip"}
                                icon={starIcon}>&lt;/TrayIcon>
                            &lt;ReactTooltip id={"source-code-tooltip"} place={"bottom"} effect={"solid"}>&lt;/ReactTooltip>
                            &lt;TrayIcon
                                data-tip={"Vote"}
                                data-for={"vote-tooltip"}
                                icon={likeIcon}
                            >&lt;/TrayIcon>

                            &lt;ReactTooltip id={"vote-tooltip"} place={"bottom"} effect={"solid"}>&lt;/ReactTooltip>
                        &lt;/Tray>

                    &lt;/Header>

                    {isUsingDemoApi &amp;&amp; &lt;Panel>&lt;Text>
                        Using demo api. Only some queries like "Weather" work!. Go to &lt;Link
                        onClick={() => {
                            setState({...state, currentView: "Settings"})
                        }
                        }
                        active={false}>settings&lt;/Link> to add your own api key. Get your api key
                        from &lt;Link
                        href={"https://developer.wolframalpha.com/portal/myapps/"}>here&lt;/Link>
                    &lt;/Text>&lt;/Panel>
                    }
                    {/*Setting view*/}
                    {state.currentView === "Settings" &amp;&amp;
                        &lt;SettingsView
                        />
                    }

                    {state.currentView === "WolframAlpha" &amp;&amp;
                        &lt;div
                            style={{
                                marginLeft: "5%",
                                marginRight: "5%",
                                marginBottom: "5%",
                                backgroundColor: "rgb(0,0,0,0)", border: "none", boxShadow: "none"

                            }}
                        >
                            &lt;WolframAlphaSearchArea onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                    sendQueryToBackGround(e.target.value, "", true, "")
                                }
                            }} onClick={() => {
                                sendQueryToBackGround(document.getElementById("wolframQueryInput").value,
                                    "", true, "")

                            }}



                            />
                            {/*{state.loadingResult === false ?
                                renderAssumptions() : &lt;LoaderScreen
                                    message={"Inject Wis-doom everywhere"}/>}*/}
                            {currentPageReadability &amp;&amp;
                                &lt;Panel>
                                    {renderEntities()}

                                &lt;/Panel>
                            }
                            {renderAssumptions()}
                            {renderPods()}

                        &lt;/div>
                    }
                &lt;/Island>
            &lt;/Sidebar>


        &lt;/div>
    )
}


</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://raw.githubusercontent.com/nhannht/wisdoom/master/src/icons/wisdoomIcon.svg" style="width: 30px; height: 30px">
    <div class="footer-text">Let the wisdom of the crowd guide you</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
